# 네이버 블로그 기반 워드 클라우드 기능 설계 문서 (최종)

## 1. 기능 목적

특정 차량 모델에 대해 **지정한 기준 월(month)** 에 수행된 블로그 검색 결과를 기반으로  
다음 정보를 데이터베이스에 저장하고, 대시보드(Model Detail)에서 시각화하기 위한 기능이다.

- 네이버 블로그 상위 글(상위 3개) 메타 정보 저장
- 본문 텍스트 정제 및 형태소 분석
- 단어(명사) 빈도 분석
- 월간 워드클라우드 이미지 생성
- 월 단위 캐싱을 통해 동일 월 재수집 방지

본 기능은 시장 관심도와 별도로 “사용자가 해당 모델에 대해 어떤 주제를 많이 언급하는지”를 파악하는 보조 분석 지표로 활용된다.

---

## 2. 기능 개요

관리자(Admin) 페이지에서 사용자가 **버튼을 누르는 시점**에만 블로그 분석이 실행된다.  
자동 배치(스케줄링)는 하지 않는다.

1. 관리자가 특정 월(month)을 선택하고 “블로그 분석 실행” 버튼 클릭
2. 모든 모델(or 선택된 모델)에 대해 처리
3. 지정한 월에 대해 이미 분석된 결과가 있으면 **중복 수집을 차단하고 스킵**
4. 없으면:
   - 네이버 블로그 검색 API 호출
   - 상위 3개 글 본문 크롤링
   - 텍스트 정제
   - 형태소 분석(명사 추출)
   - 토큰 빈도 집계 → `blog_token_monthly` 저장
   - 워드클라우드 생성 → `blog_wordcloud` 저장
   - 블로그 메타/본문 → `blog_article` 저장

---

## 3. 기준 월(month) 정의

본 기능의 모든 데이터는 다음 기준을 따른다.

- `month` = “분석 기준 월”
- 사용자가 Admin 페이지에서 선택한 월(`YYYY-MM` → 내부적으로 `YYYY-MM-01` DATE)
- 모든 결과(`blog_article`, `blog_token_monthly`, `blog_wordcloud`)는 이 `month` 기준으로 저장된다.

예:  
2025년 11월에 대한 블로그 분석 실행 → `month = 2025-11-01`

---

## 4. 중복 수집 차단(월 단위 캐싱)

동일 `(model_id, month)`에 대해 이미 분석된 데이터가 있으면 **절대 재수집되지 않는다.**

### 판정 기준

다음 조건 중 하나라도 존재하면 “이미 분석된 월”로 간주하여 스킵한다.

```sql
SELECT 1
FROM blog_token_monthly
WHERE model_id = :model_id
  AND month = :month
LIMIT 1;
```

### 스킵 시 동작

- 네이버 API 호출 없음
- 본문 크롤링 없음
- 형태소 분석 없음
- 토큰 저장 없음
- 워드클라우드 생성 없음
- 단순히 “스킵” 로그만 남긴다

즉, 한 모델의 한 월은 **딱 한 번만** 분석된다.

---

## 5. 실행 플로우 (Admin 버튼 트리거)

```
[Admin 페이지]
      ↓
사용자 기준 월(month) 선택
      ↓
"블로그 분석 실행" 버튼 클릭
      ↓
모델 목록(car_model) 순회
      ↓
이미 분석된 모델/월? → 예 → 스킵
                      → 아니오 → 수집/분석 수행
```

---

## 6. 처리 상세 단계

### 6.1. 네이버 블로그 검색 API 호출

- 검색 키워드: 모델명(예: “스포티지”, “쏘나타 디 엣지”)
- 상위 3개의 결과만 수집
- `blog_article` 테이블에 저장
  - `month`
  - `model_id`
  - `search_keyword`
  - `search_rank`
  - `title`
  - `url`
  - `summary`
  - `content_plain`(전처리된 본문)
  - `collected_at`
  - `posted_at`(가능하면)

---

### 6.2. 블로그 본문 크롤링 & 전처리

HTML → 텍스트로 정제:

- HTML 태그 제거
- 광고/홍보 문구 제거
- 특수문자, 이모티콘 제거
- 연속 공백 정리

결과는 `blog_article.content_plain`에 저장된다.

---

### 6.3. 형태소 분석(명사 추출)

- 형태소 분석기: MeCab-ko 권장
- 글 3개 전체를 하나의 분석 단위로 묶거나, 글별 추출 후 합산
- 필터링:
  - 한 글자 단어 제거
  - 의미 없는 단어 제거(불용어)
  - 자동차와 무관한 확장 불용어 적용 가능

---

### 6.4. 단어 빈도 계산 → `blog_token_monthly`

- Counter 구조로 명사 등장 횟수 집계
- 전체 토큰을 등장 빈도순으로 정렬한 뒤 상위 N개만 추출(N=30~50 권장)
- `blog_token_monthly` 테이블에 다음 형태로 저장:

| model_id | month | token | total_count | token_rank | created_at |
| -------- | ----- | ----- | ----------- | ---------- | ---------- |

- `(model_id, month)`에 기존 데이터가 있으면 **수집 단계에서 이미 스킵**되므로 삽입되지 않음

---

### 6.5. 워드클라우드 생성 → `blog_wordcloud`

- `blog_token_monthly`의 상위 토큰과 빈도를 사용
- 크기: 800×600 PNG 권장
- 글꼴, 마스킹 옵션 자유
- 파일 저장 경로: `data/wordcloud/{model_id}_{month}.png`
- DB에는 `image_path`와 `generated_at` 기록

---

## 7. 캐싱 구조 요약

### 1) 텍스트 캐시

- `blog_article`
  - 동일 `(model_id, month)`로 이미 수집된 글이 있으면 재크롤링 안 함
  - 이 단계에서도 “스킵” 판단 가능하지만, 최종 기준은 `blog_token_monthly`

### 2) 분석 결과 캐시

- `blog_token_monthly`
- `blog_wordcloud`  
  → 동일 `(model_id, month)`가 존재하면 **전체 분석 스킵**

---

## 8. 확장 옵션: 강제 새로고침(force refresh)

지금은 기본적으로 **같은 월은 절대 다시 분석되지 않음**  
원하면 Admin 페이지에 “강제 새로고침” 옵션을 추가해서:

- 해당 `(model_id, month)`의
  - `blog_article`
  - `blog_token_monthly`
  - `blog_wordcloud`
    를 모두 삭제한 뒤
- 다시 분석을 수행할 수도 있다.

현재 기본 정책: **강제 새로고침 기능 없음(=중복 분석 차단)**

---

## 9. 데이터베이스 테이블 사용 요약

### `blog_article`

- 블로그 상위 3개 글
- 수집 텍스트 캐시
- 기준 월은 `month` 컬럼

### `blog_token_monthly`

- 명사 토큰 기반 상위 단어 집계
- 기준 월은 `month` 컬럼
- **중복 분석 여부 판단의 핵심 테이블**

### `blog_wordcloud`

- 토큰 월간 결과 기반 이미지 파일
- 기준 월은 `month` 컬럼

---

## 10. 모델 상세 페이지(Model Detail) UI 요소

1. 월 선택 드롭다운(사용자 관점)
2. 블로그 상위 3개 글 목록
3. 키워드 TOP N 막대 그래프
4. 워드클라우드 이미지
5. 분석 기준 월 표시

---

## 11. 결론

본 기능은 “월 단위 블로그 인식 변화”를 정량화하는 기능이며,  
중복 수집 차단 정책(월 단위 캐싱)을 적용하여 **API 비용 절감** 및 **데이터 일관성**을 유지한다.

Admin 페이지에서 “월 선택 → 실행”이라는 단순한 사용 흐름으로  
모든 모델에 대한 월간 키워드/워드클라우드 분석을 안정적으로 수행할 수 있다.
